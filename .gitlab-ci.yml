default:
  tags:
    - workflow

stages:
  - precheck
  - build
  - prescan
  - push
  - postscan
  - test
  - deploy

variables:
  DOCKER_REGISTRY: "harbor.local:8080"
  DOCKER_USER: "$CI_HARBOR_USER"
  DOCKER_PASSWORD: "$CI_HARBOR_PASSWORD"
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: "tcp://docker:2375"
  TRIVY_VERSION: "latest"
  TRIVY_CACHE: .trivycache

.docker_service: &docker_service
  name: "docker:24.0.5-dind"
  alias: "docker"
  command: ["--tls=false", "--host=tcp://0.0.0.0:2375", "--insecure-registry=harbor.local:8080"]

.default_setup: &default_setup
  before_script:
    - apk add --no-cache jq curl
    - timeout 60 sh -c 'until docker version >/dev/null 2>&1; do echo "Waiting for Docker..."; sleep 5; done'
    - echo "$DOCKER_PASSWORD" | docker login "$DOCKER_REGISTRY" -u "$DOCKER_USER" --password-stdin
    - mkdir -p "$TRIVY_CACHE"
    - sleep 10
    - docker version || (echo "Docker unavailable!" && exit 1)

.trivy_scan: &trivy_scan
  - |
    docker run --rm \
      -v /var/run/docker.sock:/var/run/docker.sock \
      -v "$(pwd)/${SCAN_DIR}:/report" \
      -v "$(pwd)/$TRIVY_CACHE:/root/.cache/trivy" \
      aquasec/trivy:${TRIVY_VERSION} \
      image \
      --cache-dir /root/.cache/trivy \
      --timeout 10m \
      --format json \
      --output /report/${IMAGE_NAME}.json \
      --exit-code 0 \
      $SCAN_TARGET

.json_to_csv: &json_to_csv
  - |
    if [ -f "${SCAN_DIR}/${IMAGE_NAME}.json" ]; then
      jq -r '.Results[]?.Vulnerabilities[]? | [.VulnerabilityID, .PkgName, .InstalledVersion, .FixedVersion, .Severity, .Title] | @csv' \
        "${SCAN_DIR}/${IMAGE_NAME}.json" > "${SCAN_DIR}/${IMAGE_NAME}.csv"
      echo "Scan completed - Reports: ${SCAN_DIR}/"
      ls -la "${SCAN_DIR}/"
    else
      echo "Trivy scan failed (JSON report missing)"
      exit 1
    fi

.scan_artifacts: &scan_artifacts
  artifacts:
    paths: 
      - ${SCAN_DIR}/
    when: always
    expire_in: 1 week
  allow_failure: true

login_harbor:
  stage: precheck
  image: "docker:24.0.5"
  services: [*docker_service]
  <<: *default_setup
  script:
    - echo "Login Harbor..."
    - docker info

.build_and_scan_template: &build_and_scan_template
  stage: build
  image: "docker:24.0.5"
  services: [*docker_service]
  cache:
    key: trivy-cache
    paths: [ .trivycache/ ]
  before_script:
    - apk add --no-cache jq curl
    - echo "$DOCKER_PASSWORD" | docker login "$DOCKER_REGISTRY" -u "$DOCKER_USER" --password-stdin
    - mkdir -p "$TRIVY_CACHE" "${SCAN_DIR}"
    - sleep 10
    - docker version || (echo "Docker unavailable!" && exit 1)
  script:
    - echo "Building ${IMAGE_NAME}..."
    - docker build -t "$DOCKER_REGISTRY/workflow/${IMAGE_NAME}:latest" "./${IMAGE_NAME}"
    
    - IMAGE_ID=$(docker images -q "$DOCKER_REGISTRY/workflow/${IMAGE_NAME}:latest")
    - echo "Scanning image ID: $IMAGE_ID"
    
    - echo "Starting pre-push scan of ${IMAGE_NAME}"
    - SCAN_TARGET=$IMAGE_ID
    - *trivy_scan
    - *json_to_csv
  <<: *scan_artifacts

build_and_scan_backend:
  <<: *build_and_scan_template
  needs: ["login_harbor"]
  variables:
    IMAGE_NAME: "backend"
    SCAN_DIR: "scan_pre_push_backend"

build_and_scan_frontend:
  <<: *build_and_scan_template
  needs: ["login_harbor"]
  variables:
    IMAGE_NAME: "frontend"
    SCAN_DIR: "scan_pre_push_frontend"

push_images:
  stage: push
  image: "docker:24.0.5"
  services: [*docker_service]
  before_script:
    - apk add --no-cache curl
    - echo "$DOCKER_PASSWORD" | docker login "$DOCKER_REGISTRY" -u "$DOCKER_USER" --password-stdin
    - sleep 5
    - docker version
  needs: ["build_and_scan_backend", "build_and_scan_frontend"]
  script:
    - echo "Pushing images to registry..."
    - |
      for image in backend frontend; do
        echo "Building and pushing $image..."
        docker build -t "$DOCKER_REGISTRY/workflow/$image:latest" "./$image"
        docker push "$DOCKER_REGISTRY/workflow/$image:latest" || { echo "push $image failed"; exit 1; }
        echo "$image pushed successfully"
      done

.scan_post_push_template: &scan_post_push_template
  stage: postscan
  image: "docker:24.0.5"
  services: [*docker_service]
  cache:
    key: trivy-cache
    paths: [ .trivycache/ ]
  before_script:
    - apk add --no-cache jq curl
    - echo "$DOCKER_PASSWORD" | docker login "$DOCKER_REGISTRY" -u "$DOCKER_USER" --password-stdin
    - mkdir -p "$TRIVY_CACHE" "${SCAN_DIR}"
    - sleep 10
    - docker version || (echo "Docker unavailable!" && exit 1)
  script:
    - echo "Starting post-push scan of ${IMAGE_NAME}"
    - docker pull "${IMAGE_TO_SCAN}" || (echo "Unable to pull ${IMAGE_TO_SCAN}" && exit 1)
    - SCAN_TARGET="${IMAGE_TO_SCAN}"
    - *trivy_scan
    - *json_to_csv
  <<: *scan_artifacts

scan_post_push_backend:
  <<: *scan_post_push_template
  needs: ["push_images"]
  variables:
    SCAN_DIR: "scan_post_push_backend"
    IMAGE_NAME: "backend"
    IMAGE_TO_SCAN: "$DOCKER_REGISTRY/workflow/backend:latest"

scan_post_push_frontend:
  <<: *scan_post_push_template
  needs: ["push_images"]
  variables:
    SCAN_DIR: "scan_post_push_frontend"
    IMAGE_NAME: "frontend"
    IMAGE_TO_SCAN: "$DOCKER_REGISTRY/workflow/frontend:latest"

.test_template: &test_template
  stage: test
  image: "docker:24.0.5"
  services: [*docker_service]
  before_script:
    - apk add --no-cache curl
    - echo "$DOCKER_PASSWORD" | docker login "$DOCKER_REGISTRY" -u "$DOCKER_USER" --password-stdin
    - sleep 5
    - docker version
  script:
    - echo "Running tests for ${IMAGE_NAME}..."
    - docker pull "$DOCKER_REGISTRY/workflow/${IMAGE_NAME}:latest" || (echo "Unable to pull ${IMAGE_NAME}" && exit 1)
    - docker run --rm "$DOCKER_REGISTRY/workflow/${IMAGE_NAME}:latest" $TEST_CMD
  allow_failure: false

test_backend:
  <<: *test_template
  needs: ["scan_post_push_backend"]
  variables:
    IMAGE_NAME: "backend"
    TEST_CMD: "pytest -v"

test_frontend:
  <<: *test_template
  needs: ["scan_post_push_frontend"]
  variables:
    IMAGE_NAME: "frontend"
    TEST_CMD: "npm test -- --watchAll=false"

deploy_local:
  stage: deploy
  image: "docker:24.0.5"
  services: [*docker_service]
  before_script:
    - apk add --no-cache curl
    - echo "$DOCKER_PASSWORD" | docker login "$DOCKER_REGISTRY" -u "$DOCKER_USER" --password-stdin
  needs: ["test_backend", "test_frontend"]
  script:
    - echo "DEPLOYING TO DIND ENVIRONMENT..."
    - |
      echo "Current directory: $(pwd)"
      echo "Directory content:"
      ls -la
      
      docker compose down || echo "No running containers"
      docker pull "$DOCKER_REGISTRY/workflow/backend:latest"
      docker pull "$DOCKER_REGISTRY/workflow/frontend:latest"
      docker compose up -d
      sleep 15
      docker compose ps
    - |
      echo "=== COMPREHENSIVE TESTS ==="
      
      echo "Waiting for services to start..."
      sleep 30
      
      echo "1. Backend health check with retry:"
      docker run --rm --network workflow-complet_default \
        curlimages/curl:8.12.1 \
        sh -c "for i in 1 2 3 4 5; do curl -f http://backend:5000/health && exit 0; sleep 5; done; exit 1" \
        && echo "Backend health OK" || echo "Backend health failed"
      
      echo "2. Frontend check:"
      docker run --rm --network workflow-complet_default \
        curlimages/curl:8.12.1 \
        curl http://frontend:3000 | grep -q "Hello" \
        && echo "Frontend OK" || echo "Frontend failed"
      
      echo "3. Inter-service communication:"
      docker run --rm --network workflow-complet_default \
        curlimages/curl:8.12.1 \
        curl http://backend:5000/ | grep -q "Hello" \

      echo "DEPLOYMENT SUCCESSFUL!"
  environment:
    name: production
  allow_failure: false