stages:
  - precheck
  - build_and_scan
  - postscan
  - test
  - deploy
  - notification

variables:
  DOCKER_REGISTRY: "harbor.local:8080"
  DOCKER_USER: "$CI_HARBOR_USER"
  DOCKER_PASSWORD: "$CI_HARBOR_PASSWORD"
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: "tcp://docker:2375"
  TRIVY_VERSION: "latest"
  TRIVY_CACHE: .trivycache

.docker_service: &docker_service
  name: "docker:24.0.5-dind"
  alias: "docker"
  command: ["--tls=false", "--host=tcp://0.0.0.0:2375", "--insecure-registry=harbor.local:8080"]

.default_setup: &default_setup
  before_script:
    - apk add --no-cache jq curl
    - timeout 60 sh -c 'until docker version >/dev/null 2>&1; do echo "En attente de Docker..."; sleep 5; done'
    - echo "$DOCKER_PASSWORD" | docker login "$DOCKER_REGISTRY" -u "$DOCKER_USER" --password-stdin
    - mkdir -p "$TRIVY_CACHE"
    - sleep 10
    - docker version || (echo "Docker indisponible !" && exit 1)

.trivy_scan: &trivy_scan
  - |
    docker run --rm \
      -v /var/run/docker.sock:/var/run/docker.sock \
      -v "$(pwd)/${SCAN_DIR}:/report" \
      -v "$(pwd)/$TRIVY_CACHE:/root/.cache/trivy" \
      aquasec/trivy:${TRIVY_VERSION} \
      image \
      --cache-dir /root/.cache/trivy \
      --timeout 10m \
      --format json \
      --output /report/${IMAGE_NAME}.json \
      --severity HIGH,CRITICAL \
      --exit-code 1 \
      $SCAN_TARGET

.json_to_csv: &json_to_csv
  - |
    if [ -f "${SCAN_DIR}/${IMAGE_NAME}.json" ]; then
      jq -r '.Results[]?.Vulnerabilities[]? | [.VulnerabilityID, .PkgName, .InstalledVersion, .FixedVersion, .Severity, .Title] | @csv' \
        "${SCAN_DIR}/${IMAGE_NAME}.json" > "${SCAN_DIR}/${IMAGE_NAME}.csv"
      echo "Analyse terminée - Rapports : ${SCAN_DIR}/"
      ls -la "${SCAN_DIR}/"
    else
      echo "Echec de l'analyse Trivy (rapport JSON manquant)"
      exit 1
    fi

.scan_artifacts: &scan_artifacts
  artifacts:
    paths: 
      - ${SCAN_DIR}/
    when: always
    expire_in: 1 week
  allow_failure: true

login_harbor:
  tags: [workflow]
  stage: precheck
  image: "docker:24.0.5"
  services: [*docker_service]
  <<: *default_setup
  script:
    - echo "Connexion a Harbor..."
    - docker info

.build_and_scan_template: &build_and_scan_template
  stage: build_and_scan
  image: "docker:24.0.5"
  services: [*docker_service]
  cache:
    key: trivy-cache
    paths: [ .trivycache/ ]
  before_script:
    - apk add --no-cache jq curl
    - echo "$DOCKER_PASSWORD" | docker login "$DOCKER_REGISTRY" -u "$DOCKER_USER" --password-stdin
    - mkdir -p "$TRIVY_CACHE" "${SCAN_DIR}"
    - sleep 10
    - docker version || (echo "Docker indisponible !" && exit 1)
  script:
    - echo "Construction de ${IMAGE_NAME}..."
    - docker build -t "$DOCKER_REGISTRY/workflow/${IMAGE_NAME}:latest" "./${IMAGE_NAME}"
    
    - IMAGE_ID=$(docker images -q "$DOCKER_REGISTRY/workflow/${IMAGE_NAME}:latest")
    - |
      echo "Analyse de l'image ID : $IMAGE_ID"
    
    - echo "Debut de l'analyse pre-push de ${IMAGE_NAME}"
    - SCAN_TARGET=$IMAGE_ID
    - *trivy_scan
    - *json_to_csv

    - echo "Envoi de l'image ${IMAGE_NAME} au registre..."
    - docker push "$DOCKER_REGISTRY/workflow/${IMAGE_NAME}:latest"
    - echo "${IMAGE_NAME} envoyé avec succès"
    
  <<: *scan_artifacts

build_and_scan_backend:
  tags: [workflow]
  <<: *build_and_scan_template
  needs: ["login_harbor"]
  variables:
    IMAGE_NAME: "backend"
    SCAN_DIR: "scan_pre_push_backend"

build_and_scan_frontend:
  tags: [workflow]
  <<: *build_and_scan_template
  needs: ["login_harbor"]
  variables:
    IMAGE_NAME: "frontend"
    SCAN_DIR: "scan_pre_push_frontend"

.scan_post_push_template: &scan_post_push_template
  stage: postscan
  image: "docker:24.0.5"
  services: [*docker_service]
  cache:
    key: trivy-cache
    paths: [ .trivycache/ ]
  before_script:
    - apk add --no-cache jq curl
    - echo "$DOCKER_PASSWORD" | docker login "$DOCKER_REGISTRY" -u "$DOCKER_USER" --password-stdin
    - mkdir -p "$TRIVY_CACHE" "${SCAN_DIR}"
    - sleep 10
    - docker version || (echo "Docker indisponible !" && exit 1)
  script:
    - echo "Debut de l'analyse post-push de ${IMAGE_NAME}"
    - docker pull "${IMAGE_TO_SCAN}" || (echo "Impossible de recuperer ${IMAGE_TO_SCAN}" && exit 1)
    - SCAN_TARGET="${IMAGE_TO_SCAN}"
    - *trivy_scan
    - *json_to_csv
  <<: *scan_artifacts

scan_post_push_backend:
  tags: [workflow]
  <<: *scan_post_push_template
  needs: ["build_and_scan_backend"]
  variables:
    SCAN_DIR: "scan_post_push_backend"
    IMAGE_NAME: "backend"
    IMAGE_TO_SCAN: "$DOCKER_REGISTRY/workflow/backend:latest"

scan_post_push_frontend:
  tags: [workflow]
  <<: *scan_post_push_template
  needs: ["build_and_scan_frontend"]
  variables:
    SCAN_DIR: "scan_post_push_frontend"
    IMAGE_NAME: "frontend"
    IMAGE_TO_SCAN: "$DOCKER_REGISTRY/workflow/frontend:latest"

.test_template: &test_template
  stage: test
  image: "docker:24.0.5"
  services: [*docker_service]
  before_script:
    - apk add --no-cache curl
    - echo "$DOCKER_PASSWORD" | docker login "$DOCKER_REGISTRY" -u "$DOCKER_USER" --password-stdin
    - sleep 5
    - docker version
  script:
    - echo "Execution des tests pour ${IMAGE_NAME}..."
    - docker pull "$DOCKER_REGISTRY/workflow/${IMAGE_NAME}:latest" || (echo "Impossible de recuperer ${IMAGE_NAME}" && exit 1)
    - docker run --rm "$DOCKER_REGISTRY/workflow/${IMAGE_NAME}:latest" $TEST_CMD
  allow_failure: false

test_backend:
  tags: [workflow]
  <<: *test_template
  needs: ["scan_post_push_backend"]
  variables:
    IMAGE_NAME: "backend"
    TEST_CMD: "pytest -v"

test_frontend:
  tags: [workflow]
  <<: *test_template
  needs: ["scan_post_push_frontend"]
  variables:
    IMAGE_NAME: "frontend"
    TEST_CMD: "npm test -- --watchAll=false"

deploy_local:
  tags: [workflow-deploy]
  stage: deploy
  image: 
    name: docker:24.0.5
    entrypoint: [""]
  variables:
    DOCKER_HOST: ""
  before_script:
    - apk add --no-cache curl docker-compose
    - echo "$DOCKER_PASSWORD" | docker login "$DOCKER_REGISTRY" -u "$DOCKER_USER" --password-stdin
  needs: ["test_backend", "test_frontend"]
  script:
    - echo "Deploiement vers l'environnement Docker hote..."
    - |
      echo "Information Docker hote :"
      docker version
      echo "Conteneurs actuels sur l'hote :"
      docker ps -a
      
      echo "Arret des conteneurs existants :"
      docker compose down || echo "Aucun conteneur en cours d'execution"
      
      echo "Recuperation des dernieres images :"
      docker pull "$DOCKER_REGISTRY/workflow/backend:latest"
      docker pull "$DOCKER_REGISTRY/workflow/frontend:latest"
      
      echo "Demarrage des services :"
      docker compose up -d
      
      echo "Verification :"
      sleep 15
      echo "Statut Docker Compose :"
      docker compose ps
      echo "Tous les conteneurs de l'hote :"
      docker ps
    - |
      echo "Controles de sante sur les ports de l'hote :"
      sleep 30
      
      HOST_IP=$(ip route | grep default | awk '{print $3}')
      echo "Utilisation de l'IP de l'hote : $HOST_IP"
      
      echo "Controle backend :"
      curl -f http://$HOST_IP:5000/health && echo "Backend operationnel" || (echo "Echec du backend" && docker compose logs backend)
      
      echo "Controle frontend :"
      curl -f http://$HOST_IP:3000 && echo "Frontend operationnel" || (echo "Echec du frontend" && docker compose logs frontend)
      
      echo "Deploiement reussi"
      echo "Les conteneurs sont maintenant en cours d'execution sur Docker hote"
      echo "Visualisation avec : docker ps"
      echo "Acces via : http://localhost:3000 (frontend) et http://localhost:5000 (backend)"
  environment:
    name: production
  allow_failure: false

send_whatsapp_notification:
  stage: notification
  image: curlimages/curl:8.12.1
  script:
    - |
      MESSAGE="Pipeline #$CI_PIPELINE_ID termine avec succes sur le projet $CI_PROJECT_NAME (branche $CI_COMMIT_REF_NAME)."
      curl -X POST "https://api.twilio.com/2010-04-01/Accounts/$TWILIO_ACCOUNT_SID/Messages.json" \
      --data-urlencode "From=$TWILIO_WHATSAPP_FROM" \
      --data-urlencode "To=$TWILIO_WHATSAPP_TO" \
      --data-urlencode "Body=$MESSAGE" \
      -u "$TWILIO_ACCOUNT_SID:$TWILIO_AUTH_TOKEN"
  when: always
  needs: []